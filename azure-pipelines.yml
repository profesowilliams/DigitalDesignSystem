# azure-pipelines.yml

# ðŸ‘‡ Event to trigger pipeline execution
trigger:
  branches:
    include:
      - main # ðŸ‘ˆ Filters the execution to run only on the main branch
    exclude:
      - develop # ðŸ‘ˆ Excludes the develop branch

# ðŸ‘‡ Configures pipeline execution on pull requests
pr:
  branches:
    include:
      - main # ðŸ‘ˆ Filters the execution to run only on the pull requests for the main branch
    exclude:
      - develop # ðŸ‘ˆ Excludes the pull requests for the develop branch

# Other configurations

# Pipeline stages
stages:
  - stage: Test
    displayName: Chromatic Testing
    # Job list
    jobs:
      - job: Chromatic_Deploy
        displayName: Install packages and publishes to Chromatic
        variables:
          # Sets scoped environment variable to cache packages
          npm_config_cache: $(Pipeline.Workspace)/.npm
        # List of steps
        steps:
          - checkout: self
            displayName: 'Get full Git history'
            fetchDepth: 0
          # ðŸ‘‡ Installs and configures Node environment
          - task: NodeTool@0
            inputs:
              versionSpec: '16.x'
            displayName: 'Install Node.js'
          - task: Cache@2
            displayName: Install and cache packages
            inputs:
              key: 'npm | "$(Agent.OS)" | package-lock.json'
              restoreKeys: |
                npm | "$(Agent.OS)"
              path: $(npm_config_cache)
          - script: npm ci
            condition: ne(variables.CACHE_RESTORED, 'true')
            # ðŸ‘‡ Adds Chromatic as a step
          - task: CmdLine@2
            displayName: Publish to Chromatic
            inputs:
              # ðŸ‘‡ Runs Chromatic
              script: npx chromatic --auto-accept-changes
            env:
              CHROMATIC_PROJECT_TOKEN: $(CHROMATIC_PROJECT_TOKEN)
